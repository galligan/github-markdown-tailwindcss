name: Update CSS

on:
  release:
    types: [published]
    repositories:
      - sindresorhus/github-markdown-css

jobs:
  update-css:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install dependencies
        run: npm install

      - name: Fetch latest release information
        id: fetch_release
        run: |
          latest_release=$(curl -s https://api.github.com/repos/sindresorhus/github-markdown-css/releases/latest)
          echo "::set-output name=tag::$(echo $latest_release | jq -r .tag_name)"
          echo "::set-output name=css_url::$(echo $latest_release | jq -r .assets[0].browser_download_url)"

      - name: Download CSS file
        run: |
          mkdir -p build
          curl -L ${{ steps.fetch_release.outputs.css_url }} -o build/github-markdown.css

      - name: Create new branch
        run: |
          git checkout -b update-css-${{ steps.fetch_release.outputs.tag }}

      - name: Convert CSS to TailwindCSS
        run: node convert-to-tailwind.js

      - name: Commit changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "Update CSS to version ${{ steps.fetch_release.outputs.tag }}"

      - name: Push changes
        run: git push --set-upstream origin update-css-${{ steps.fetch_release.outputs.tag }}

      - name: Create pull request
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update CSS to version ${{ steps.fetch_release.outputs.tag }}"
          branch: update-css-${{ steps.fetch_release.outputs.tag }}
          title: "Update CSS to version ${{ steps.fetch_release.outputs.tag }}"
          body: "This PR updates the CSS to version ${{ steps.fetch_release.outputs.tag }}."

      - name: Wait for pull request to be merged
        uses: actions/github-script@v3
        with:
          script: |
            const pr = await github.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            while (pr.data.merged_at === null) {
              await new Promise(resolve => setTimeout(resolve, 10000));
              pr = await github.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
              });
            }

      - name: Create release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.fetch_release.outputs.tag }}
          release_name: ${{ steps.fetch_release.outputs.tag }}
          body: |
            This release updates the CSS to version ${{ steps.fetch_release.outputs.tag }}.
            Refer to the upstream release notes for more details: https://github.com/sindresorhus/github-markdown-css/releases/tag/${{ steps.fetch_release.outputs.tag }}
          files: build/github-markdown-tailwind.css
